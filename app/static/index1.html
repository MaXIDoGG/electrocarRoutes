<!DOCTYPE html>
<html>

<head>
	<title>Electric Car Route Finder</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	<style>
		#map {
			height: 400px;
			width: 100%;
		}
	</style>
</head>

<body>
	<div>
		<label for="startLat">Start Latitude:</label>
		<input type="text" id="startLat">
		<label for="startLon">Start Longitude:</label>
		<input type="text" id="startLon">
	</div>
	<div>
		<label for="endLat">End Latitude:</label>
		<input type="text" id="endLat">
		<label for="endLon">End Longitude:</label>
		<input type="text" id="endLon">
	</div>
	<div>
		<label for="maxDistance">Max Distance (meters):</label>
		<input type="text" id="maxDistance">
	</div>
	<button onclick="findRoute()">Find Route</button>
	<button onclick="clearMarkers()">Clear Markers</button>
	<div id="map"></div>

	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<script>
		var map = L.map('map').setView([51.505, -0.09], 13); // Начальные координаты и уровень масштабирования

		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
		}).addTo(map);

		var startLatInput = document.getElementById('startLat');
		var startLonInput = document.getElementById('startLon');
		var endLatInput = document.getElementById('endLat');
		var endLonInput = document.getElementById('endLon');
		var maxMarkers = 2;
		var startMarker, endMarker;

		map.on('click', function (e) {
			if (startMarker && endMarker) {
				return; // ограничиваем количество меток
			}

			var lat = e.latlng.lat.toFixed(6);
			var lon = e.latlng.lng.toFixed(6);

			var markerColor = startMarker ? 'red' : 'blue'; // определение цвета маркера

			var marker = L.marker([lat, lon], { icon: coloredIcon(markerColor) }).addTo(map);
			if (!startMarker) {
				startMarker = marker;
				startLatInput.value = lat;
				startLonInput.value = lon;
			} else {
				endMarker = marker;
				endLatInput.value = lat;
				endLonInput.value = lon;
			}
		});

		function findRoute() {
			if (!startMarker || !endMarker) {
				alert("Please set both start and end points.");
				return;
			}

			var startLat = parseFloat(startLatInput.value);
			var startLon = parseFloat(startLonInput.value);
			var endLat = parseFloat(endLatInput.value);
			var endLon = parseFloat(endLonInput.value);
			var maxDistance = parseInt(document.getElementById('maxDistance').value);

			var requestData = {
				start_lat: startLat,
				start_lon: startLon,
				end_lat: endLat,
				end_lon: endLon,
				max_distance: maxDistance
			};

			fetch('http://127.0.0.1:8000/route', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(requestData)
			})
				.then(response => response.json())
				.then(data => {
					console.log(data)
					console.log(data.route)
					var route = JSON.parse(data).route;
					console.log(route)


					var latLngs = route.map(function (point) {
						return L.latLng(point[0], point[1]);
					});

					var polyline = L.polyline(latLngs, { color: 'red' }).addTo(map);
					map.fitBounds(polyline.getBounds());
				})
				.catch(error => {
					console.error('Error:', error);
				});
		}

		function clearMarkers() {
			if (startMarker) {
				map.removeLayer(startMarker);
				startMarker = null;
				startLatInput.value = '';
				startLonInput.value = '';
			}
			if (endMarker) {
				map.removeLayer(endMarker);
				endMarker = null;
				endLatInput.value = '';
				endLonInput.value = '';
			}
		}

		function coloredIcon(color) {
			return new L.Icon({
				iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
				shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
				iconSize: [25, 41],
				iconAnchor: [12, 41],
				popupAnchor: [1, -34],
				shadowSize: [41, 41]
			});
		}
	</script>
</body>

</html>